csa lab 3
========================

- Кобик Никита Алекссевич 
- P3224
- ```asm | stack | harv | hw | instr | binary -> struct | trap -> stream | mem | cstr | prob1 | spi```
- Базовый вариант, без усложнения

## Язык программирования

```ebnf
program         ::=     { statement }

statement       ::=     section       [ comment ] "\n"
                      | declaration   [ comment ] "\n"
                      | label         [ comment ] "\n"
                      | instruction   [ comment ] "\n"
                      |               [ comment ] "\n"

section         ::=     "." section_name
section_name    ::=     "data" | "code"

declaration     ::=     variable_name value
variable_name   ::=     <any of "a-z A-Z _"> { <any of "a-z A-Z 0-9 _"> }
value           ::=     number | string
number          ::=     { <any of "0-9"> }
string          ::=     "\"" { <any symbols except "\""> } "\""
                      | "\'" { <any symbols except "\'"> } "\'"

label           ::=     label_name ":"
label_name      ::=     <any of "a-z A-Z _"> { <any of "a-z A-Z 0-9 _"> }

instruction     ::=     opcode_0
                      | opcode_1 operand
                      | opcode_2 label_name
              
opcode_0        ::=     "pop" 
                      | "read" 
                      | "write" 
                      | "compare" 
                      | "add" 
                      | "sub" 
                      | "mul" 
                      | "div" 
                      | "inc" 
                      | "dec" 
                      | "halt"

opcode_1        ::=     "push" 
                      | "save"
                      
opcode_2        ::=     "jmp" 
                      | "jeq" 
                      | "jne" 
                      | "jla" 
                      | "jle"

operand         ::=     value | variable_name

comment         ::=     "#" <any symbols except "\n">
```

Примечания:
- Код выполняется последовательно
- Первая указанная команда в сегменте инструкций считается началом программы
- Все переменные должны быть объявлены до использования в секции данных
- В программе не может быть меток, переменных и команд с одинаковыми именами
- Метки могут быть объявлены в любом месте программы, на отдельной строке
- Использование метки означает переход к инструкции, перед которой она определена
- Метка `on_input` определяет исполняемый блок прерывания для чтения

## Система команд

Набор инструкций:
- `push variable_name` -- положить адрес переменной на вершину стека `[...] -> [..., address]`
- `push value` -- положить значение на вершину стека `[...] -> [..., value]`
- `pop` -- переместить указатель вершины стека на одну ячейку вниз `[..., a, b] -> [..., a]`
- `read variable_name` -- прочитать ячейку памяти по адресу переменной `[...] -> [..., value]`
- `read` -- прочитать ячейку памяти по адресу с вершины стека данных `[..., address] -> [..., value]`
- `save address` -- сохранить значение с вершины стека в память по указанному адресу `[..., value] -> [...]`
- `save` -- вершина стека -> адрес сохранения, второе значение сверху -> значение `[..., value, address] -> [...]`
- `swap` -- поменять местами два верхних значения на стеке данных `[..., a, b] -> [..., b, a]` 
- `duplicate` -- дублировать верхнее значение на стеке данных `[..., a] -> [..., a, a]`
- `compare` -- сравнить два значения со стека `[..., a, b] -> [...]`
- `jump` -- безусловный переход на метку
- `jeq` -- переход на метку, если результат последнего сравнения `a == b`
- `jne` -- переход на метку, если результат последнего сравнения `a != b`
- `jla` -- переход на метку, если результат последнего сравнения `a > b`
- `jle` -- переход на метку, если результат последнего сравнения `a < b`
- `add` -- сложить два значения с вершины стека `[..., a, b] -> [..., a + b]`
- `sub` -- вычесть два значения с вершины стека `[..., a, b] -> [..., a - b]`
- `mul` -- умножить два значения с вершины стека `[..., a, b] -> [..., a * b]`
- `div` -- разделить два значения с вершины стека `[..., a, b] -> [..., a // b]`
- `inc` -- увеличить значение на вершине стека на 1 `[..., a] -> [..., a + 1]`
- `dec` -- уменьшить значение на вершине стека на 1 `[..., a] -> [..., a - 1]`
- `return` -- возврат из прерывания
- `nope` -- ничего не делать
- `halt` -- завершить выполнение программы

## Организация памяти

Данные и инструкции имеют разные места хранения, согласно Гарвардской архитектуре 

```
    data memory
+------------------+
| 00 :     in      |
| 01 :     out     |
| 02 :     ...     |
+------------------+

 instruction memory 
+------------------+
| 00 :     ...     |
|          ...     |
| n  :     203     |
+------------------+
```

Исходный код транслируется в бинарный файл, содержащий две секции - данные и инструкции
- В секции данных размер машинного слова не определен
- В секции инструкций размер машинного слова - 8 байт, содержащих тип инструкции (1 байт), тип операнда (1 байт) и сам операнд (6 байт)

У программиста нет доступа к памяти инструкций

В системе поддерживаются целые знаковые числа (integer), символы (char), строки (string)

Порты ввода-вывода отображаются в память. Для доступа к ним используются обращения к определенным заранее ячейкам в памяти данных

Адресация - прямая, с использованием переменных (подставляется адрес ячейки в памяти данных) и меток (адрес ячейки в памяти инструкций)

Строки представлены в виде массива символов, переменная -- ссылка на первый элемент 
(например, если в переменную `text` записана строка и данные сохранены в ячейках памяти, начиная с 24, то `push text` повлияет на стек данных как `[...] -> [..., 24]`)

## Транслятор

```
python assemble_unit.py <source_filepath> <target_filepath>
```

Трансляция реализуется в несколько этапов:
- Очистка исходного кода от пустых строк и комментариев
- Проверка синтаксиса программы
- Парсинг переменных и лейблов
- Парсинг инструкций
- Подстановка адресов переменных и лейблов
- Генерация бинарного кода

## Модель процессора

```
python machine.py <bin_filepath> <input_filepath> <output_filepath> <log_filepath>
```

```text
Control Unit

                interruption signal
        +-----------------------------------+
        |           instruction             |
        |      +---------------------+      |
        |      |                     |      |
        |      |       Z flag        v      v    
+-------+------+------+ --- > +------+------+-------+ --- > +------+
|      Data Path      |       | Instruction Decoder |       | Tick |
+-------+------+------+ --- > +------+------+-------+ < --- +------+ 
        ^      ^       N flag        |      |
        |      |                     |      |
        |      +---------------------+      |
        |            flow signal            |
        +-----------------------------------+
                 interruption signal
```

```text
Data Path
      
+--------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                                                                                                  |
|       rs_write        rs_read                                                                                                                    | 
|      +-----------------------+                                                                                                                   |
|      |     Return  Stack     | < --------------------+                                                                                           |
|      +-------+---------------+                       |                                                                                           |
|              |                                       |                                                                                           |
|              |       +-----------------------+       |                                      instruction                 interruption signal      |
|              |       | +1                    |       |                                           |                               |               |
|              v       v                       |       |                im_read                    |                               v               |
|      +-------+-------+-------+       +-------+-------+-------+       +-----------------------+   v   +-----------------------+ --- > +-----------+-----------+
+--- > |          MUX          | --- > |    Command Pointer    | --- > |  Instruction  Memory  | --- > |     Control  Unit     |       | Interruption  Handler |
       +-------+-------+-------+       +-----------+-----------+   ^   +-----------------------+       +-------+-------+-------+ < --- +-----------------------+
               ^       ^                           ^               |                                           ^       ^
               |       |                           |               |                                    N flag |       | Z flag         dm_write        dm_read
               |      sel                       latch_cp        address                 i d + - // *   +-------+-------+-------+       +-----------------------+ --- > +-----------------------+ 
               |                                                                        ------------ > |          ALU          | --- > |      Data  Memory     |       |      I/O Devices      |
               |                                                                                       +-------+-------+-------+       +---------------+-------+ < --- +-----------------------+
               |                                                                                               ^       |                               |
               |                                                                                               |       |                               |
               |                                                                                               |       +-----------------------+       |
               |                                                                                               |                               |       |
               |                                                                                               |                               v       v
               |                                                                                       +-------+---------------+ --- > +-------+-------+-------+ 
               +-------------------------------------------------------------------------------------- |      Data   Stack     |       |          MUX          | < --- sel
                                                                                                       +-----------------------+ < --- +-----------------------+
                                                                                                        ds_write        ds_read
```

Описание реализации:
- Процесс моделирования отслеживается по инструкциям
- Программа выполняется последовательно
- Остановка программы происходит:
  - при выполнении команды `halt`
  - при обращении к несуществующей ячейке памяти
  - при возникновении ошибки во время выполнения (например, деление на 0)
- Переполнение стека или памяти в данной реализации не предусмотрено
- Появление прерывания контролируется между инструкциями 
- Доступ к памяти осуществляется по адресу в специальном регистре command pointer

Флаги АЛУ:
- `zero` -- устанавливается, если результат последнего сравнения a == b или результат последней арифметической операции равен 0
- `negative` -- устанавливается, если результат последнего сравнения a < b или результат последней арифметической операции отрицателен

Набор инструкций:

| Инструкция | Количество тактов |
|:----------:|:-----------------:|
|    push    |         1         |
| duplicate  |         2         |
|    pop     |         2         |
|    read    |      2 или 3      |
|  compare   |         3         |
|    jump    |         1         |
|    jla     |      1 или 2      |
|    jle     |      1 или 2      |
|    jeq     |      1 или 2      |
|    jne     |      1 или 2      |
|    add     |         4         |
|    sub     |         4         |
|    mul     |         4         |
|    div     |      3 или 4      |
|    inc     |         3         |
|    dec     |         3         |
|    swap    |         4         |
|    save    |      2 или 3      |
|   return   |         1         |
|    nop     |         1         |
|    halt    |         1         |

Примечание: количество тактов в таблице указано без учета времени на выборку инструкции (2 такта)

## Тестирование

```
pytest test.py
```

Тестирование выполняется при помощи golden тестов

CI для Github Actions разделен на две задачи

Lint:
```yaml
name: Python Lint

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.11
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mypy pytest
    - name: Run mypy linter
      run: |
        mypy .
```

Test:
```yaml
name: Python Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install pytest-golden
      - name: Run golden tests
        run: |
           pytest test.py
```

Пример проверки исходного кода
```text
pytest test.py
============================= test session starts ==============================
collecting ... collected 5 items

test.py::test_translator_asm_and_machine[golden/test/prob1.yml] 
test.py::test_translator_asm_and_machine[golden/test/cat.yml] 
test.py::test_translator_asm_and_machine[golden/test/prob5.yml] 
test.py::test_translator_asm_and_machine[golden/test/hello_user.yml] 
test.py::test_translator_asm_and_machine[golden/test/hello_world.yml] 

============================== 5 passed in 4.04s ===============================
```

## Статистика

|    Тест     | Инструкций |  Исполнено  |    Такт    |
|:-----------:|:----------:|:-----------:|:----------:|
| hello world |     12     |     148     |    743     | 
| hello user  |     60     |     451     |    2328    |
|    prob1    |     69     |    27150    |   148114   |
|    prob5    |     80     |    2336     |   12881    |
|     cat     |     9      |     643     |    2238    |
